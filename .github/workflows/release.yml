name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller psutil
    
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name "SteamConnectionController" steam_connection_controller.py
    
    - name: Create release package
      run: |
        mkdir release
        copy dist\SteamConnectionController.exe release\
        copy README.md release\
        copy LICENSE release\
        copy CHANGELOG.md release\
        copy requirements.txt release\
        copy test_program.py release\
        echo @echo off > release\SteamConnectionController.bat
        echo title Steam Connection Controller >> release\SteamConnectionController.bat
        echo echo Starting Steam Connection Controller... >> release\SteamConnectionController.bat
        echo echo. >> release\SteamConnectionController.bat
        echo echo Note: This program requires administrator privileges. >> release\SteamConnectionController.bat
        echo echo. >> release\SteamConnectionController.bat
        echo SteamConnectionController.exe >> release\SteamConnectionController.bat
        echo pause >> release\SteamConnectionController.bat
    
    - name: Create ZIP archive
      run: |
        powershell Compress-Archive -Path release\* -DestinationPath SteamConnectionController_${{ github.ref_name }}.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Steam Connection Controller ${{ github.ref_name }}
        body: |
          ## Steam Connection Controller ${{ github.ref_name }}
          
          ### üéâ New Release Features
          - Control Steam's internet connection with one click
          - User-friendly interface
          - Automatic Steam detection system
          - Secure Windows Firewall integration
          - Automatic Steam management (close/restart)
          
          ### üì¶ Download
          - **SteamConnectionController_${{ github.ref_name }}.zip**: Complete package (recommended)
          - **SteamConnectionController.exe**: Standalone executable file
          
          ### üöÄ Installation
          1. Download the ZIP file and extract it
          2. Run `SteamConnectionController.bat` **as administrator**
          3. The program will automatically find Steam and start working
          
          ### ‚ö†Ô∏è Requirements
          - Windows 10/11
          - Administrator privileges
          - Steam must be installed
          
          ### üêõ Known Issues
          - Windows Defender warning may appear on first run (safe file)
          
          ### üìû Support
          For issues, use the [Issues](https://github.com/akmaster/SteamOnlineOfflineSwich/issues) section.
        files: |
          SteamConnectionController_${{ github.ref_name }}.zip
          dist/SteamConnectionController.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}